<div class="dashboard-container">
    <!-- 1. Page Header -->
    <header class="page-header">
        <div>
            <h1>Deliveries</h1>
            <p class="subtitle">Track and manage completed and ongoing deliveries</p>
        </div>
        <div class="metrics" *ngIf="deliveries.length">
            <div class="metric">
                <span class="metric-val">{{ deliveries.length }}</span>
                <span class="metric-label">Total</span>
            </div>
        </div>
    </header>

    <!-- 2. Filters Bar -->
    <section class="filters-bar">
        <div class="filter-group">
            <label>Date Range</label>
            <div class="input-doi">
                <input type="date" [(ngModel)]="filterDateStart" placeholder="From">
                <span class="sep">to</span>
                <input type="date" [(ngModel)]="filterDateEnd" placeholder="To">
            </div>
        </div>

        <div class="filter-group flex-1">
            <label>Client</label>
            <div class="search-wrap">
                <span class="icon">üîç</span>
                <input type="text" [(ngModel)]="filterClient" placeholder="Search by name or phone...">
            </div>
        </div>

        <div class="filter-group">
            <label>Agent</label>
            <select [(ngModel)]="filterAgent">
                <option value="">All Agents</option>
                <option *ngFor="let a of agents" [value]="a">{{ a }}</option>
            </select>
        </div>

        <div class="filter-actions">
            <button class="btn-reset" (click)="resetFilters()">‚Ü∫ Reset</button>
        </div>
    </section>

    <!-- Split View -->
    <main class="content-split">

        <!-- 3. Deliveries List (Left) -->
        <aside class="list-pane">
            <div class="list-header">
                <small>{{ filteredDeliveries.length }} deliveries found</small>
            </div>

            <div class="deliveries-list">
                <div class="delivery-card" *ngFor="let d of filteredDeliveries" (click)="selectDelivery(d)"
                    [class.is-active]="d === selectedDelivery">

                    <div class="card-row top">
                        <span class="d-id">{{ d.id }}</span>
                        <span class="status-badge" [ngClass]="getStatusClass(d.status)">{{ d.status }}</span>
                    </div>

                    <div class="card-row main">
                        <div class="client-info">
                            <strong>{{ d.clientName }}</strong>
                            <small>{{ d.clientAddress }}</small>
                        </div>
                    </div>

                    <div class="card-row bottom">
                        <div class="meta-item">
                            <span class="icon">üöö</span> {{ d.agentName }}
                        </div>
                        <div class="meta-item">
                            <span class="icon">üïí</span> {{ d.date | date:'shortTime' }} ‚Ä¢ {{ d.date | date:'MMM d' }}
                        </div>
                    </div>
                </div>

                <div class="empty-list" *ngIf="filteredDeliveries.length === 0">
                    <p>No deliveries match your filters.</p>
                </div>
            </div>
        </aside>

        <!-- 4. Details Panel (Right) -->
        <section class="details-pane">
            <div class="details-shell" *ngIf="selectedDelivery as sel; else noSelection">

                <div class="details-header">
                    <h2>{{ sel.clientName }}</h2>
                    <div class="dh-meta">
                        <span class="status-badge lg" [ngClass]="getStatusClass(sel.status)">{{ sel.status }}</span>
                        <span class="code-badge" *ngIf="sel.status !== 'Cancelled'">Code: <span class="mono">{{
                                sel.deliveryCode }}</span></span>
                    </div>
                </div>

                <div class="details-body">
                    <!-- Client Card -->
                    <div class="info-card">
                        <h3>Client Information</h3>
                        <div class="info-row">
                            <span class="label">Phone</span>
                            <span class="value">{{ sel.clientPhone }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Address</span>
                            <span class="value">{{ sel.clientAddress }}</span>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="info-card">
                        <h3>Order Summary <span class="badge-count">{{ sel.totalItems }} items</span></h3>
                        <ul class="med-list">
                            <li *ngFor="let m of sel.medicines">
                                <span class="m-qty">{{ m.qty }}</span>
                                <span class="m-name">{{ m.name }}</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Timeline -->
                    <div class="info-card">
                        <h3>Delivery Timeline</h3>
                        <div class="timeline">
                            <!-- Prepared -->
                            <div class="tl-step" [class.done]="sel.timeline.preparedAt">
                                <div class="tl-marker"></div>
                                <div class="tl-content">
                                    <span class="tl-title">Prepared</span>
                                    <span class="tl-time" *ngIf="sel.timeline.preparedAt">{{ sel.timeline.preparedAt |
                                        date:'mediumTime' }}</span>
                                </div>
                            </div>
                            <!-- Assigned -->
                            <div class="tl-step" [class.done]="sel.timeline.assignedAt">
                                <div class="tl-marker"></div>
                                <div class="tl-content">
                                    <span class="tl-title">Agent Assigned</span>
                                    <span class="tl-time" *ngIf="sel.timeline.assignedAt">{{ sel.timeline.assignedAt |
                                        date:'mediumTime' }} <small>({{ sel.agentName }})</small></span>
                                </div>
                            </div>
                            <!-- Picked Up -->
                            <div class="tl-step" [class.done]="sel.timeline.pickedUpAt">
                                <div class="tl-marker"></div>
                                <div class="tl-content">
                                    <span class="tl-title">Picked Up</span>
                                    <span class="tl-time" *ngIf="sel.timeline.pickedUpAt">{{ sel.timeline.pickedUpAt |
                                        date:'mediumTime' }}</span>
                                </div>
                            </div>
                            <!-- Delivered / Cancelled -->
                            <div class="tl-step" [class.done]="sel.timeline.deliveredAt || sel.status === 'Cancelled'"
                                [class.cancelled]="sel.status === 'Cancelled'">
                                <div class="tl-marker"></div>
                                <div class="tl-content">
                                    <span class="tl-title">{{ sel.status === 'Cancelled' ? 'Cancelled' : 'Delivered'
                                        }}</span>
                                    <span class="tl-time" *ngIf="sel.timeline.deliveredAt">{{ sel.timeline.deliveredAt |
                                        date:'mediumTime' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <ng-template #noSelection>
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <h3>Select a delivery</h3>
                    <p>View detailed status, client info, and timeline.</p>
                </div>
            </ng-template>
        </section>

    </main>
</div>