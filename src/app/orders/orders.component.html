<!-- Orders Workstation (Redesigned) -->
<section class="orders-page">
  <!-- New 3-Column Workstation Layout -->
  <div class="orders-shell">
    <!-- Left: Orders Queue -->
    <aside class="col col-queue">
      <div class="sec-h">
        <h3>Orders Queue</h3>
        <small class="muted">{{ orders.length }} total</small>
      </div>
      <div class="queue">
        <button type="button" class="queue-item" *ngFor="let o of orders" (click)="selectOrder(o)" [class.is-active]="o === selectedOrder">
          <div class="q-top">
            <span class="q-name">{{ o.client.name }}</span>
            <span class="q-time mono">{{ o.time }}</span>
          </div>
          <div class="q-bottom">
            <span class="status-badge" [ngClass]="statusClass(o.status)">{{ o.status }}</span>
          </div>
        </button>
      </div>
    </aside>

    <!-- Center: Workspace -->
    <main class="col col-workspace" *ngIf="selectedOrder as sel">
      <!-- Client -->
      <section class="ws-section client">
        <div class="sec-h"><h3>Client</h3></div>
        <div class="client-grid">
          <div><div class="label">Name</div><div class="value">{{ sel.client.name }}</div></div>
          <div><div class="label">Age</div><div class="value">{{ sel.client.age }}</div></div>
          <div><div class="label">Phone</div><div class="value">{{ sel.client.phone }}</div></div>
          <div class="span2"><div class="label">Address</div><div class="value">{{ sel.client.address }}</div></div>
        </div>
      </section>

      <!-- Prescription Viewer -->
      <section class="ws-section prescription">
        <div class="sec-h"><h3>Prescription</h3></div>
        <div class="tabs">
          <button type="button" class="tab" [class.is-active]="activeTab === 'text'" (click)="setTab('text')" [disabled]="!sel.prescriptionText">Text</button>
          <button type="button" class="tab" [class.is-active]="activeTab === 'image'" (click)="setTab('image')" [disabled]="!sel.prescriptionImageUrl">Image</button>
        </div>
        <div class="tab-panel" *ngIf="activeTab === 'text'">
          <pre class="rx-text">{{ sel.prescriptionText || 'No text prescription provided.' }}</pre>
        </div>
        <div class="tab-panel" *ngIf="activeTab === 'image'">
          <div class="img-tools">
            <button type="button" class="btn" (click)="zoomOut()" [disabled]="imgZoom <= 0.6">-</button>
            <span class="mono">{{ imgZoom | number:'1.0-1' }}x</span>
            <button type="button" class="btn" (click)="zoomIn()" [disabled]="imgZoom >= 2">+</button>
          </div>
          <div class="img-wrap">
            <img [src]="sel.prescriptionImageUrl" alt="Prescription" [style.transform]="'scale(' + imgZoom + ')'">
          </div>
        </div>
      </section>

      <!-- Medicines Verification -->
      <section class="ws-section meds">
        <div class="sec-h"><h3>Medicines</h3></div>
        <input type="text" [(ngModel)]="medSearch" placeholder="Search medicines" />
        <div class="meds-list">
          <div class="med-row" *ngFor="let m of visibleMedicines">
            <div class="med-left">
              <img *ngIf="m.imageUrl" [src]="m.imageUrl" [alt]="m.name" class="med-thumb" />
              <div class="med-name">{{ m.name }}</div>
            </div>
            <div class="med-right">
              <span class="status-badge" [ngClass]="!m.existsInStock ? 'badge--missing' : (m.recipeValidated ? 'badge--available' : 'badge--missing')">
                {{ !m.existsInStock ? 'Missing' : (m.recipeValidated ? 'Validated' : 'Incomplete') }}
              </span>
            </div>
          </div>
        </div>

        <!-- Per-medicine editor -->
        <div class="meds-list">
          <div class="med-row" *ngFor="let m of visibleMedicines">
            <div class="med-left">
              <div class="med-name">{{ m.name }}</div>
            </div>
            <div class="med-right">
              <label style="margin-right:6px"><input type="radio" name="exist-{{m.id}}" [checked]="m.existsInStock" (change)="onAvailabilityChange(sel, m, true)" /> Exists</label>
              <label><input type="radio" name="exist-{{m.id}}" [checked]="!m.existsInStock" (change)="onAvailabilityChange(sel, m, false)" /> Does not exist</label>
            </div>
            <div class="med-editor" style="grid-column: 1 / -1; margin-top:8px" [class.disabled]="!m.existsInStock">
              <div class="form-grid">
                <label>Dosage<input type="text" [(ngModel)]="m.dosage" [disabled]="!m.existsInStock || m.recipeValidated" /></label>
                <label>Frequency<input type="text" [(ngModel)]="m.frequency" placeholder="e.g. 2x/day" [disabled]="!m.existsInStock || m.recipeValidated" /></label>
                <label>Duration<input type="text" [(ngModel)]="m.duration" placeholder="e.g. 7 days" [disabled]="!m.existsInStock || m.recipeValidated" /></label>
                <div>
                  <div class="label">Intake timing</div>
                  <label><input type="checkbox" [(ngModel)]="m.intakeTimes.morning" [disabled]="!m.existsInStock || m.recipeValidated" /> Morning</label>
                  <label><input type="checkbox" [(ngModel)]="m.intakeTimes.noon" [disabled]="!m.existsInStock || m.recipeValidated" /> Noon</label>
                  <label><input type="checkbox" [(ngModel)]="m.intakeTimes.night" [disabled]="!m.existsInStock || m.recipeValidated" /> Night</label>
                  <label><input type="checkbox" [(ngModel)]="m.intakeTimes.beforeMeals" [disabled]="!m.existsInStock || m.recipeValidated" /> Before meals</label>
                </div>
                <label>Warnings<textarea rows="2" [(ngModel)]="m.warnings" [disabled]="!m.existsInStock || m.recipeValidated"></textarea></label>
              </div>
              <div class="stack">
                <button class="btn btn--primary" type="button" (click)="validateMedicine(m)" [disabled]="!canValidateMedicine(m) || !m.existsInStock || m.recipeValidated">Validate</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sticky Decision Bar: progress + gated actions -->
        <div class="decision-bar">
          <div class="muted" style="margin-right:auto">
            <ng-container *ngIf="sel.status !== 'Declined'; else declinedMsg">
              Completed {{ validatedCount(sel) }} / {{ sel.medicines.length }}
            </ng-container>
            <ng-template #declinedMsg>
              Order declined • Forwarded to: {{ sel.forwardedTo || 'Another pharmacy' }}
            </ng-template>
          </div>
          <button type="button" class="btn" (click)="sendCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Send to client</button>
          <button type="button" class="btn" (click)="printCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Print</button>
          <button type="button" class="btn btn--primary" (click)="markWaitingForDelivery()" [disabled]="!isOrderFullyValidated(sel)">Move to Waiting for Delivery</button>
        </div>
      </section>
    </main>

    <!-- Right: Action Panel -->
    <aside class="col col-actions" *ngIf="selectedOrder as sel">
      <div class="actions-panel">
        <ng-container [ngSwitch]="sel.status">
          <div *ngSwitchCase="'New'">
            <h3>Actions</h3>
            <p class="muted">Complete each medicine recipe. Actions unlock when all medicines are validated.</p>
            <div class="stack">
              <button class="btn" type="button" (click)="sendCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Send to client</button>
              <button class="btn" type="button" (click)="printCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Print</button>
              <button class="btn btn--primary" type="button" (click)="markWaitingForDelivery()" [disabled]="!isOrderFullyValidated(sel)">Move to Waiting for Delivery</button>
            </div>
          </div>
          <div *ngSwitchCase="'Prepared'">
            <h3>Actions</h3>
            <div class="stack">
              <button class="btn" type="button" (click)="sendCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Send to client</button>
              <button class="btn" type="button" (click)="printCombinedRecipe()" [disabled]="!isOrderFullyValidated(sel)">Print</button>
              <button class="btn btn--primary" type="button" (click)="markWaitingForDelivery()" [disabled]="!isOrderFullyValidated(sel)">Move to Waiting for Delivery</button>
            </div>
          </div>
          <div *ngSwitchCase="'Waiting for Delivery'">
            <h3>Driver Claim</h3>
            <div class="drivers-list">
              <div class="driver-row" *ngFor="let d of drivers">
                <div>{{ d.name }} • {{ d.area }}</div>
                <button class="btn" type="button" [disabled]="!d.available" (click)="claimOrder(sel.id, d.id)">{{ d.available ? 'Claim as ' + d.name : 'Busy' }}</button>
              </div>
            </div>
          </div>
          <div *ngSwitchCase="'Assigned'">
            <h3>Pickup Verification</h3>
            <div class="code-box">
              <div class="label">Security code</div>
              <div class="code mono">{{ sel.pickupCode }}</div>
            </div>
            <div class="form-grid">
              <label>Enter code<input type="text" [(ngModel)]="pickupInput" /></label>
            </div>
            <div class="stack">
              <button class="btn btn--primary" type="button" (click)="verifyPickupCode()">Confirm pickup</button>
            </div>
          </div>
          <div *ngSwitchCase="'On The Way'">
            <h3>Delivery</h3>
            <div class="stack">
              <button class="btn btn--primary" type="button" (click)="markDelivered()">Mark Delivered</button>
            </div>
          </div>
          <div *ngSwitchCase="'Delivered'">
            <h3>Delivered</h3>
            <button class="btn" type="button" (click)="printCombinedRecipe()">Print Recipe</button>
          </div>
          <div *ngSwitchCase="'Declined'">
            <h3>Order Declined</h3>
            <p class="muted">Forwarded to: {{ sel.forwardedTo || 'Another pharmacy' }}</p>
          </div>
          <div *ngSwitchDefault>
            <p class="muted">Select an order.</p>
          </div>
        </ng-container>
      </div>
    </aside>
  </div>

  <!-- Legacy UI disabled to avoid reuse of old layout -->
  <ng-container *ngIf="false">
  <!-- Filters Top -->
  <div class="filters">
    <div class="field">
      <label for="search">Search</label>
      <input id="search" type="text" [(ngModel)]="searchQuery" placeholder="Search by ID, client, address" />
    </div>

    <div class="field">
      <label for="status">Status</label>
      <select id="status" [(ngModel)]="statusFilter">
        <option value="">All</option>
        <option value="New">New</option>
        <option value="Prepared">Prepared</option>
        <option value="Waiting for Delivery">Waiting for Delivery</option>
        <option value="Assigned">Assigned</option>
        <option value="On The Way">On The Way</option>
        <option value="Delivered">Delivered</option>
      </select>
    </div>

    <div class="field">
      <label for="date">Date</label>
      <select id="date" [(ngModel)]="dateFilter">
        <option value="">All</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
      </select>
    </div>
  </div>

  <!-- Main Layout: List + Details -->
  <div class="orders-layout">
    <!-- Orders Table -->
    <div class="panel panel--list">
      <div class="panel-header">
        <h3>Orders</h3>
        <small>{{ filteredOrders.length }} results</small>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Client</th>
              <th>Type</th>
              <th>Status</th>
              <th>Time</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let o of filteredOrders" (click)="selectOrder(o)" [class.is-active]="o === selectedOrder">
              <td class="mono">{{ o.id }}</td>
              <td>
                <div class="client">
                  <div class="client__name">{{ o.client.name }}</div>
                  <small class="muted">{{ o.client.address }}</small>
                </div>
              </td>
              <td>
                <span class="badge badge--type" [class.is-prescription]="o.type === 'Prescription'">{{ o.type }}</span>
              </td>
              <td>
                <span class="badge"
                  [ngClass]="{
                    'badge--new': o.status === 'New',
                    'badge--prepared': o.status === 'Prepared',
                    'badge--waiting': o.status === 'Waiting for Delivery',
                    'badge--assigned': o.status === 'Assigned',
                    'badge--ontheway': o.status === 'On The Way',
                    'badge--delivered': o.status === 'Delivered'
                  }"
                >{{ o.status }}</span>
              </td>
              <td class="mono">{{ o.time }}</td>
              <td>
                <button type="button" class="btn btn--ghost" (click)="$event.stopPropagation(); selectOrder(o)">View</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Details Panel -->
    <div class="panel panel--details" *ngIf="selectedOrder as sel">
      <div class="panel-header">
        <h3>Order Details</h3>
        <small class="mono">{{ sel.id }}</small>
      </div>

      <div class="details">
        <!-- Client Info -->
        <div class="card">
          <h4>Client</h4>
          <div class="grid-2">
            <div>
              <div class="label">Name</div>
              <div class="value">{{ sel.client.name }}</div>
            </div>
            <div>
              <div class="label">Phone</div>
              <div class="value">{{ sel.client.phone }}</div>
            </div>
          </div>
          <div class="label">Address</div>
          <div class="value">{{ sel.client.address }}</div>
        </div>

        <!-- Order Content -->
        <div class="card">
          <h4>Order Content</h4>
          <ul class="items">
            <li *ngFor="let it of sel.items">{{ it }}</li>
          </ul>
        </div>

        <!-- Prescription Preview -->
        <div class="card" *ngIf="sel.prescriptionImageUrl">
          <h4>Prescription</h4>
          <img [src]="sel.prescriptionImageUrl" alt="Prescription" class="rx-img" />
        </div>

        <!-- Timeline -->
        <div class="card">
          <h4>Timeline</h4>
          <div class="timeline">
            <div class="step" [class.done]="true">New</div>
            <div class="step" [class.done]="sel.status === 'Prepared' || sel.status === 'Waiting for Delivery' || sel.status === 'Assigned' || sel.status === 'On The Way' || sel.status === 'Delivered'">Prepared</div>
            <div class="step" [class.done]="sel.status === 'Waiting for Delivery' || sel.status === 'Assigned' || sel.status === 'On The Way' || sel.status === 'Delivered'">Waiting for Delivery</div>
            <div class="step" [class.done]="sel.status === 'Assigned' || sel.status === 'On The Way' || sel.status === 'Delivered'">Assigned</div>
            <div class="step" [class.done]="sel.status === 'On The Way' || sel.status === 'Delivered'">On The Way</div>
            <div class="step" [class.done]="sel.status === 'Delivered'">Delivered</div>
          </div>
        </div>

        <!-- Delivery Workflow -->
        <div class="card">
          <h4>Delivery Workflow</h4>
          <ng-container [ngSwitch]="sel.status">
            <div *ngSwitchCase="'New'" class="assign-actions">
              <button type="button" class="btn btn--primary" (click)="markPrepared()">Mark Prepared</button>
            </div>

            <div *ngSwitchCase="'Prepared'" class="assign-actions">
              <button type="button" class="btn btn--primary" (click)="moveToWaitingForDelivery()">Move to Waiting for Delivery</button>
            </div>

            <div *ngSwitchCase="'Waiting for Delivery'">
              <div class="claim-zone">
                <div>
                  <div class="label">Waiting for delivery drivers</div>
                  <small class="muted">First available driver who claims gets assigned</small>
                </div>
                <div class="assign-actions">
                  <button type="button" class="btn" (click)="simulateRandomClaim()">Simulate Claim</button>
                </div>
              </div>
              <div class="drivers-list">
                <div class="driver-row" *ngFor="let d of drivers">
                  <div class="value">{{ d.name }} • {{ d.area }}</div>
                  <button type="button" class="btn" [disabled]="!d.available" (click)="claimOrder(sel.id, d.id)">{{ d.available ? 'Claim as ' + d.name : 'Busy' }}</button>
                </div>
              </div>
              <!-- TODO: Replace with OrdersService.claimOrder(orderId, driverId) -->
            </div>

            <div *ngSwitchCase="'Assigned'">
              <div class="driver-lock" *ngIf="sel.assignedDriverId as did">
                Assigned to: <strong>{{ getDriverName(did) }}</strong>
              </div>
              <div class="assign-actions">
                <button type="button" class="btn btn--primary" (click)="startDelivery()">Start Delivery</button>
              </div>
            </div>

            <div *ngSwitchCase="'On The Way'">
              <div class="assign-actions">
                <button type="button" class="btn btn--primary" (click)="markDelivered()">Mark Delivered</button>
              </div>
            </div>

            <div *ngSwitchCase="'Delivered'">
              <div class="muted">Order delivered. Workflow completed.</div>
            </div>
          </ng-container>
        </div>

        

        <!-- Map -->
        <div class="card card--map" *ngIf="sel.status === 'On The Way' || sel.status === 'Delivered'">
          <h4>Map</h4>
          <div id="ordersMap" class="map"></div>
          <!-- TODO: Real-time tracking via WebSocket to update driver location -->
        </div>
      </div>
    </div>
  </div>
  </ng-container>
</section>
